<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Viewer</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; background:#fff; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
.container { display:flex; height:100vh; flex-direction:column; }
.header { background:#075E54; color:white; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #064e4a; }
.header h1 { font-size:16px; font-weight:500; }
.upload-section { background:#f5f5f5; padding:16px; border-bottom:1px solid #e0e0e0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.file-input-wrapper { position:relative; overflow:hidden; display:inline-block; }
.file-input-wrapper input[type=file] { position:absolute; left:-9999px; }
.upload-btn { background:#075E54; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-size:14px; font-weight:500; transition:background 0.3s; }
.upload-btn:hover { background:#064e4a; }
.search-box { flex:1; max-width:200px; padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:14px; background:white; }
.chat-container { flex:1; overflow-y:auto; padding:16px; background:#ECE5DD; display:flex; flex-direction:column; }
.no-chat { display:flex; align-items:center; justify-content:center; height:100%; color:#888; text-align:center; }
.message { display:flex; margin-bottom:4px; max-width:70%; align-items:flex-end; word-wrap:break-word; }
.message.sent { justify-content:flex-end; margin-left:auto; flex-direction:row-reverse; }
.message.received { justify-content:flex-start; margin-right:auto; flex-direction:row; }
.message-bubble { padding:8px 12px; border-radius:18px; word-wrap:break-word; word-break:break-word; font-size:15px; box-shadow:0 1px 1px rgba(0,0,0,0.12); }
.message.sent .message-bubble { background:#DCF8C6; color:#000; border-bottom-right-radius:4px; }
.message.received .message-bubble { background:#fff; color:#000; border-bottom-left-radius:4px; box-shadow:0 1px 0.5px rgba(0,0,0,0.13); }
.message-time { font-size:12px; color:#999; margin:0 8px; white-space:nowrap; flex-shrink:0; }
.date-divider { text-align:center; margin:16px 0; color:#999; font-size:13px; }
.date-divider-line { display:inline-block; background:rgba(0,0,0,0.06); padding:8px 16px; border-radius:8px; }
.highlight { background-color:#ffeb3b; }
.chat-container::-webkit-scrollbar { width:8px; }
.chat-container::-webkit-scrollbar-track { background:transparent; }
.chat-container::-webkit-scrollbar-thumb { background:#075E54; border-radius:5px; }
.chat-container::-webkit-scrollbar-thumb:hover { background:#054d42; }
</style>
</head>
<body>
<div class="container">
    <div class="header"><h1>WhatsApp Viewer</h1></div>

    <div class="upload-section">
        <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".txt" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">اختر ملف</button>
        </div>
        <input type="text" id="searchBox" class="search-box" placeholder="ابحث عن الرسائل...">
        <button class="upload-btn" onclick="jumpToDate()">اذهب لتاريخ</button>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="no-chat"><div><p>اختر ملف TXT لدردشة WhatsApp</p><p style="font-size:12px;margin-top:8px;color:#aaa;">صيغة: DD/MM/YYYY، HH:MM ص/م - الراسل: الرسالة</p></div></div>
    </div>
</div>

<script>
let allMessages = [];
let currentSearchTerm = '';
document.getElementById('fileInput').addEventListener('change', handleFileUpload);
document.getElementById('searchBox').addEventListener('input', handleSearch);

function handleFileUpload(event){
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
        parseAndDisplay(e.target.result);
    };
    reader.readAsText(file);
}

function parseAndDisplay(content){
    const lines = content.split('\n');
    allMessages = [];
    const senders = new Set();
    const pattern = /^([\d‏/]+)،\s*([\d:]+)\s*([صم])\s*-\s*(.+?):\s*(.*)$/;
    for(const line of lines){
        if(!line.trim()) continue;
        const match = line.match(pattern);
        if(match){
            const date = match[1].replace(/‏/g,'').trim();
            const time = match[2] + ' ' + match[3];
            const sender = match[4].trim();
            const text = match[5].trim();
            allMessages.push({date,time,sender,text});
            senders.add(sender);
        }
    }
    const senderArray = Array.from(senders);
    window.sender1 = senderArray[0]||'';
    renderMessages(allMessages);
}

function renderMessages(messages){
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = '';
    if(messages.length===0){
        chatContainer.innerHTML='<div class="no-chat"><div><p>لم يتم العثور على رسائل</p></div></div>';
        return;
    }
    let lastDate='';
    for(const msg of messages){
        if(msg.date!==lastDate){
            lastDate=msg.date;
            const dateDiv=document.createElement('div');
            dateDiv.className='date-divider';
            dateDiv.innerHTML=`<span class="date-divider-line">${msg.date}</span>`;
            chatContainer.appendChild(dateDiv);
        }
        const isSender1=msg.sender===window.sender1;
        const msgElement=document.createElement('div');
        msgElement.className=isSender1?'message sent':'message received';
        const bubble=document.createElement('div');
        bubble.className='message-bubble';
        bubble.textContent=msg.text;
        if(currentSearchTerm && msg.text.toLowerCase().includes(currentSearchTerm.toLowerCase())){
            highlightText(bubble,currentSearchTerm);
        }
        const timeDiv=document.createElement('div');
        timeDiv.className='message-time';
        timeDiv.textContent=msg.time;
        msgElement.appendChild(bubble);
        msgElement.appendChild(timeDiv);
        chatContainer.appendChild(msgElement);
    }
    if(!currentSearchTerm){
        setTimeout(()=>{chatContainer.scrollTop=chatContainer.scrollHeight;},50);
    }
}

function highlightText(element,searchTerm){
    const text=element.textContent;
    const regex=new RegExp(`(${searchTerm})`,'gi');
    const parts=text.split(regex);
    element.innerHTML='';
    parts.forEach(part=>{
        if(regex.test(part)){
            const span=document.createElement('span');
            span.className='highlight';
            span.textContent=part;
            element.appendChild(span);
            regex.lastIndex=0;
        }else{
            element.appendChild(document.createTextNode(part));
        }
    });
}

function handleSearch(event){
    currentSearchTerm=event.target.value;
    if(!currentSearchTerm){renderMessages(allMessages); return;}
    const filtered=allMessages.filter(msg=>msg.text.toLowerCase().includes(currentSearchTerm.toLowerCase()));
    renderMessages(filtered);
}

// دالة الانتقال لتاريخ مع تنظيف النصوص
function jumpToDate(){
    let dateInput = prompt("أدخل التاريخ بالصيغة DD/MM/YYYY:");
    if(!dateInput) return;

    dateInput = dateInput.replace(/\s|‏/g,''); // إزالة الفراغات والعلامات الغريبة

    const chatContainer = document.getElementById('chatContainer');
    const messages = chatContainer.querySelectorAll('.message, .date-divider');
    let found = false;

    for(let elem of messages){
        if(elem.classList.contains('date-divider')){
            let elemDate = elem.textContent.replace(/\s|‏/g,'');
            if(elemDate.includes(dateInput)){
                elem.scrollIntoView({behavior:"smooth", block:"start"});
                found = true;
                break;
            }
        }
    }

    if(!found) alert("لا توجد رسائل بهذا التاريخ.");
}
</script>
</body>
</html>